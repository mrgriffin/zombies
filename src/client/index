<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chat example</title>
<style>
#messages { position: relative; }
#ping { position: absolute; top: 0; right: 0; }
</style>
</head>
<body>
<div id="messages"><h1>Messages</h1><span id="ping"></span></div>
<input id="message" type="text"><input id="cmd" type="button" value="Join">
<script>
var connected = false;

function doChat() {
	if (!connected) joinRoom();
	else sendMessage();
}

function joinRoom() {
	var request = new XMLHttpRequest();
	request.onreadystatechange = function () {
		if (request.readyState == 4 && request.status == 200) {
			document.getElementById('cmd').value = 'Send';
			connected = true;
		}
	};
	request.open('POST', '/join', true);
	request.send(document.getElementById('message').value);
	document.getElementById('message').value = "";
}

function sendMessage() {
	var request = new XMLHttpRequest();
	request.open('POST', '/chat', true);
	request.send(document.getElementById('message').value);
	document.getElementById('message').value = "";
}

document.getElementById('cmd').addEventListener('click', doChat, false);
document.getElementById('message').addEventListener('keydown', function (e) { if (e.keyCode == 13) doChat(); }, false);

function handleJoin(name) {
	var message = document.createElement('em');
	message.appendChild(document.createTextNode(name + ' has joined the room.'));
	document.getElementById('messages').appendChild(message);
	document.getElementById('messages').appendChild(document.createElement('br'));
}

function handleMessage(message) {
	document.getElementById('messages').appendChild(document.createTextNode(message));
	document.getElementById('messages').appendChild(document.createElement('br'));
}

function handlePing(ping) {
	document.getElementById('ping').innerHTML = 'Ping: ' + ping;
}

function update(failures, maxFailures) {
	var request = new XMLHttpRequest();
	request.onreadystatechange = function () {
		// FIXME: Occasionally we lose the first response.
		if (request.readyState == 4) {
			if (request.status == 200) {
				eval(request.responseText);
			} else {
				failures++;
			}

			if (failures < maxFailures) update(failures, maxFailures);
		}
	};
	request.open('GET', '/update', true);
	request.send(null);
}

update(0, 5);
</script>
</body>
</html>
